<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Cloud Storage Client</title>
  <script src="https://unpkg.com/vue@3"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; max-width: 600px; margin: auto }
    input, button { margin: .5rem 0; display: block; width: 100% }
  </style>
</head>
<body>
  <div id="app">
    <!-- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è -->
    <template v-if="!token">
      <h2>–í—Ö–æ–¥</h2>
      <input v-model="email"    placeholder="Email" />
      <input v-model="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
      <button @click="login">–í–æ–π—Ç–∏</button>
      <button @click="register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      <div style="color:red">{{ authError }}</div>
    </template>

    <!-- –ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ -->
    <template v-else>
      <h2>–ü—Ä–∏–≤–µ—Ç, {{ profile.email }}</h2>
      <button @click="logout">–í—ã–π—Ç–∏</button>

      <h3>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞</h3>
      <input type="file" ref="f" />
      <button @click="upload">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>

      <h3>–ú–æ–∏ —Ñ–∞–π–ª—ã ({{ files.length }})</h3>
      <ul>
        <li v-for="f in files" :key="f">
          {{ f }}
          <button @click="download(f)">üì•</button>
          <button @click="remove(f)">üóë</button>
        </li>
      </ul>

      <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
      <div>–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: {{ stats.total_files }}</div>
      <div>–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä: {{ stats.total_size }} –±–∞–π—Ç</div>
    </template>
  </div>

  <script>
  const API = "http://localhost:8002"
  const app = Vue.createApp({
    data() {
      return {
        email: "",
        password: "",
        token: localStorage.token || "",
        authError: "",
        profile: {},
        files: [],
        stats: {}
      }
    },
    created() {
      if (this.token) this.fetchAll()
    },
    methods: {
      async register() { await this.auth("/auth/register") },
      async login()    { await this.auth("/auth/login")    },

      async auth(path) {
        this.authError = ""
        try {
          const res = await fetch(API + path, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email:this.email, password:this.password })
          })
          if (!res.ok) throw await res.json()
          const data = await res.json()
          this.token = data.access_token
          localStorage.token = this.token
          await this.fetchAll()
        } catch (e) {
          this.authError = e.detail || JSON.stringify(e)
        }
      },

      logout() {
        this.token = ""
        localStorage.removeItem("token")
        this.profile = {}
        this.files = []
        this.stats = {}
      },

      authHeaders() {
        return { "Authorization": "Bearer " + this.token }
      },

      async fetchAll() {
        // 1. –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const me = await fetch(API + "/auth/me", {
          headers: this.authHeaders()
        })
        this.profile = await me.json()

        // 2. –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
        const fl = await fetch(API + "/files/", {
          headers: this.authHeaders()
        })
        this.files = await fl.json()

        // 3. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const st = await fetch(API + "/files/stats", {
          headers: this.authHeaders()
        })
        this.stats = await st.json()
      },

      async upload() {
        const file = this.$refs.f.files[0]
        if (!file) return

        const fd = new FormData()
        fd.append("file", file)

        await fetch(API + "/files/upload", {
          method: "POST",
          headers: this.authHeaders(),
          body: fd
        })
        await this.fetchAll()
      },

      download(name) {
        // –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –Ω–∞—á–∞–ª —Å–∫–∞—á–∏–≤–∞—Ç—å
        window.open(`${API}/files/download/${encodeURIComponent(name)}?token=${this.token}`)
      },

      async remove(name) {
        await fetch(`${API}/files/${encodeURIComponent(name)}`, {
          method: "DELETE",
          headers: this.authHeaders()
        })
        await this.fetchAll()
      }
    }
  }).mount("#app")
  </script>
</body>
</html>

